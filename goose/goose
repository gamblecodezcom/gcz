#!/usr/bin/env bash
set -e

GCZ_ROOT="/var/www/html/gcz"
GOOSE_HOME="$GCZ_ROOT/goose"
SESSIONS="$GOOSE_HOME/sessions"
LOGS="$GOOSE_HOME/logs"
ARCHIVE="$GCZ_ROOT/archive"

mkdir -p "$SESSIONS" "$LOGS" "$ARCHIVE"

SESSION_ID_FILE="$GOOSE_HOME/.active_session"

cmd="$1"
arg="$2"

timestamp() { date +"%Y-%m-%d %H:%M:%S"; }

log() {
  sid=$(active_session)
  msg="[$(timestamp)] $1"
  echo "$msg"
  [ -n "$sid" ] && echo "$msg" >> "$LOGS/$sid.log"
}

start_session() {
  ts=$(date +"%Y%m%d_%H%M%S")
  sid="${ts}_$RANDOM"
  mkdir -p "$SESSIONS/$sid"
  echo "$sid" > "$SESSION_ID_FILE"
  echo "$sid"
}

active_session() {
  [ -f "$SESSION_ID_FILE" ] && cat "$SESSION_ID_FILE" || true
}

index_project() {
  log "Indexing GCZ project structure..."
  tree -a -I "node_modules|__pycache__|.git|archive|sessions|logs" "$GCZ_ROOT" > "$GOOSE_HOME/project_index.txt"
  log "Project index written to goose/project_index.txt"
}

diagnose_stack() {
  log "Running system diagnostics..."
  pm2 list >> "$GOOSE_HOME/diagnostics.txt" 2>&1 || true
  log "Diagnostics written to goose/diagnostics.txt"
}

archive_old() {
  target="$ARCHIVE/$(date +"%Y%m%d")"
  mkdir -p "$target"
  log "Archiving non-core files to $target (manual review later)"
}

plan_report() {
  log "Updating deployment plan..."
  echo "# GambleCodez Deployment Plan" > "$GCZ_ROOT/GCZ_DEPLOY_PLAN.md"
  echo "Generated: $(timestamp)" >> "$GCZ_ROOT/GCZ_DEPLOY_PLAN.md"
}

summary() {
  log "Session summary complete."
}

case "$cmd" in
  start)
    sid=$(start_session)
    log "Session started: $sid"
    ;;
  resume)
    sid="$arg"
    test -z "$sid" && sid=$(active_session)
    test -z "$sid" && { echo "No session found"; exit 1; }
    echo "$sid" > "$SESSION_ID_FILE"
    log "Session resumed: $sid"
    ;;
  stop)
    summary
    rm -f "$SESSION_ID_FILE"
    echo "Session cleared"
    ;;
  logs)
    sid=$(active_session)
    test -z "$sid" && { echo "No active session"; exit 1; }
    tail -f "$LOGS/$sid.log"
    ;;
  index)
    index_project
    ;;
  diagnose)
    diagnose_stack
    ;;
  archive)
    archive_old
    ;;
  plan)
    plan_report
    ;;
  *)
    echo "Goose commands:"
    echo "  goose start"
    echo "  goose resume <id>"
    echo "  goose stop"
    echo "  goose logs"
    echo "  goose index"
    echo "  goose diagnose"
    echo "  goose archive"
    echo "  goose plan"
    ;;
esac
